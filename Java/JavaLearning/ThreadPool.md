## çº¿ç¨‹æ± 

é¡¾åæ€ä¹‰ï¼Œçº¿ç¨‹æ± å°±æ˜¯ç®¡ç†ä¸€ç³»åˆ—çº¿ç¨‹çš„èµ„æºæ± ã€‚å½“æœ‰ä»»åŠ¡è¦å¤„ç†æ—¶ï¼Œç›´æ¥ä»çº¿ç¨‹æ± ä¸­è·å–çº¿ç¨‹æ¥å¤„ç†ï¼Œå¤„ç†å®Œä¹‹åçº¿ç¨‹å¹¶ä¸ä¼šç«‹å³è¢«é”€æ¯ï¼Œè€Œæ˜¯ç­‰å¾…ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚

æ± åŒ–æŠ€æœ¯æƒ³å¿…å¤§å®¶å·²ç»å±¡è§ä¸é²œäº†ï¼Œçº¿ç¨‹æ± ã€æ•°æ®åº“è¿æ¥æ± ã€Http è¿æ¥æ± ç­‰ç­‰éƒ½æ˜¯å¯¹è¿™ä¸ªæ€æƒ³çš„åº”ç”¨ã€‚æ± åŒ–æŠ€æœ¯çš„æ€æƒ³ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘æ¯æ¬¡è·å–èµ„æºçš„æ¶ˆè€—ï¼Œæé«˜å¯¹èµ„æºçš„åˆ©ç”¨ç‡ã€‚

**çº¿ç¨‹æ± **æä¾›äº†ä¸€ç§é™åˆ¶å’Œç®¡ç†èµ„æºï¼ˆåŒ…æ‹¬æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼‰çš„æ–¹å¼ã€‚ æ¯ä¸ª**çº¿ç¨‹æ± **è¿˜ç»´æŠ¤ä¸€äº›åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚å·²å®Œæˆä»»åŠ¡çš„æ•°é‡ã€‚

è¿™é‡Œå€Ÿç”¨ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹æåˆ°çš„æ¥è¯´ä¸€ä¸‹**ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„**ï¼š

- **é™ä½èµ„æºæ¶ˆè€—**ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚
- **æé«˜å“åº”é€Ÿåº¦**ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚
- **æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§**ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚



### åˆ›å»ºçº¿ç¨‹æ± 

**æ–¹å¼ä¸€ï¼šé€šè¿‡`ThreadPoolExecutor`æ„é€ å‡½æ•°æ¥åˆ›å»ºï¼ˆæ¨èï¼‰ã€‚**

![é€šè¿‡æ„é€ æ–¹æ³•å®ç°](../java-images/threadpoolexecutoræ„é€ å‡½æ•°.d54a5992.png)

**æ–¹å¼äºŒï¼šé€šè¿‡ `Executor` æ¡†æ¶çš„å·¥å…·ç±» `Executors` æ¥åˆ›å»ºã€‚**

æˆ‘ä»¬å¯ä»¥åˆ›å»ºå¤šç§ç±»å‹çš„ `ThreadPoolExecutor`ï¼š

- **`FixedThreadPool`** ï¼š è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªå›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ã€‚è¯¥çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å§‹ç»ˆä¸å˜ã€‚å½“æœ‰ä¸€ä¸ªæ–°çš„ä»»åŠ¡æäº¤æ—¶ï¼Œçº¿ç¨‹æ± ä¸­è‹¥æœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™ç«‹å³æ‰§è¡Œã€‚è‹¥æ²¡æœ‰ï¼Œåˆ™æ–°çš„ä»»åŠ¡ä¼šè¢«æš‚å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…æœ‰çº¿ç¨‹ç©ºé—²æ—¶ï¼Œä¾¿å¤„ç†åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚
- **`SingleThreadExecutor`ï¼š** è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚è‹¥å¤šä½™ä¸€ä¸ªä»»åŠ¡è¢«æäº¤åˆ°è¯¥çº¿ç¨‹æ± ï¼Œä»»åŠ¡ä¼šè¢«ä¿å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…çº¿ç¨‹ç©ºé—²ï¼ŒæŒ‰å…ˆå…¥å…ˆå‡ºçš„é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚
- **`CachedThreadPool`ï¼š** è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªå¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´çº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ã€‚çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ä¸ç¡®å®šï¼Œä½†è‹¥æœ‰ç©ºé—²çº¿ç¨‹å¯ä»¥å¤ç”¨ï¼Œåˆ™ä¼šä¼˜å…ˆä½¿ç”¨å¯å¤ç”¨çš„çº¿ç¨‹ã€‚è‹¥æ‰€æœ‰çº¿ç¨‹å‡åœ¨å·¥ä½œï¼Œåˆæœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œåˆ™ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹å¤„ç†ä»»åŠ¡ã€‚æ‰€æœ‰çº¿ç¨‹åœ¨å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå°†è¿”å›çº¿ç¨‹æ± è¿›è¡Œå¤ç”¨ã€‚
- **`ScheduledThreadPool`** ï¼šè¯¥è¿”å›ä¸€ä¸ªç”¨æ¥åœ¨ç»™å®šçš„å»¶è¿Ÿåè¿è¡Œä»»åŠ¡æˆ–è€…å®šæœŸæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± ã€‚

ã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹ä¸­å¼ºåˆ¶çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ `Executors` å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ `ThreadPoolExecutor` æ„é€ å‡½æ•°çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©

`Executors` è¿”å›çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹(åæ–‡ä¼šè¯¦ç»†ä»‹ç»åˆ°)ï¼š

- **`FixedThreadPool` å’Œ `SingleThreadExecutor`** ï¼š ä½¿ç”¨çš„æ˜¯æ— ç•Œçš„ `LinkedBlockingQueue`ï¼Œä»»åŠ¡é˜Ÿåˆ—æœ€å¤§é•¿åº¦ä¸º `Integer.MAX_VALUE`,å¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
- **`CachedThreadPool`** ï¼šä½¿ç”¨çš„æ˜¯åŒæ­¥é˜Ÿåˆ— `SynchronousQueue`, å…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°é‡ä¸º `Integer.MAX_VALUE` ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
- **`ScheduledThreadPool` å’Œ `SingleThreadScheduledExecutor`** : ä½¿ç”¨çš„æ— ç•Œçš„å»¶è¿Ÿé˜»å¡é˜Ÿåˆ—`DelayedWorkQueue`ï¼Œä»»åŠ¡é˜Ÿåˆ—æœ€å¤§é•¿åº¦ä¸º `Integer.MAX_VALUE`,å¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚

```java
// æ— ç•Œé˜Ÿåˆ— LinkedBlockingQueue
public static ExecutorService newFixedThreadPool(int nThreads) { 

    return new ThreadPoolExecutor(nThreads, nThreads,0L, TimeUnit.MILLISECONDS,new LinkedBlockingQueue<Runnable>());

}

// æ— ç•Œé˜Ÿåˆ— LinkedBlockingQueue
public static ExecutorService newSingleThreadExecutor() { 

    return new FinalizableDelegatedExecutorService (new ThreadPoolExecutor(1, 1,0L, TimeUnit.MILLISECONDS,new LinkedBlockingQueue<Runnable>()));

}

// åŒæ­¥é˜Ÿåˆ— SynchronousQueueï¼Œæ²¡æœ‰å®¹é‡ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯ Integer.MAX_VALUE`
public static ExecutorService newCachedThreadPool() { 

    return new ThreadPoolExecutor(0, Integer.MAX_VALUE,60L, TimeUnit.SECONDS,new SynchronousQueue<Runnable>());

}

// DelayedWorkQueueï¼ˆå»¶è¿Ÿé˜»å¡é˜Ÿåˆ—ï¼‰
public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize) {
    return new ScheduledThreadPoolExecutor(corePoolSize);
}
public ScheduledThreadPoolExecutor(int corePoolSize) {
    super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS,
          new DelayedWorkQueue());
}
```



### çº¿ç¨‹æ± å‚æ•°

```java
    /**
     * ç”¨ç»™å®šçš„åˆå§‹å‚æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadPoolExecutorã€‚
     */
    public ThreadPoolExecutor(int corePoolSize,//çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡
                              int maximumPoolSize,//çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°
                              long keepAliveTime,//å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹å­˜æ´»çš„æœ€é•¿æ—¶é—´
                              TimeUnit unit,//æ—¶é—´å•ä½
                              BlockingQueue<Runnable> workQueue,//ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨æ¥å‚¨å­˜ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„é˜Ÿåˆ—
                              ThreadFactory threadFactory,//çº¿ç¨‹å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬é»˜è®¤å³å¯
                              RejectedExecutionHandler handler//æ‹’ç»ç­–ç•¥ï¼Œå½“æäº¤çš„ä»»åŠ¡è¿‡å¤šè€Œä¸èƒ½åŠæ—¶å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶ç­–ç•¥æ¥å¤„ç†ä»»åŠ¡
                               ) {
        if (corePoolSize < 0 ||
            maximumPoolSize <= 0 ||
            maximumPoolSize < corePoolSize ||
            keepAliveTime < 0)
            throw new IllegalArgumentException();
        if (workQueue == null || threadFactory == null || handler == null)
            throw new NullPointerException();
        this.corePoolSize = corePoolSize;
        this.maximumPoolSize = maximumPoolSize;
        this.workQueue = workQueue;
        this.keepAliveTime = unit.toNanos(keepAliveTime);
        this.threadFactory = threadFactory;
        this.handler = handler;
    }
```

**`ThreadPoolExecutor` 3 ä¸ªæœ€é‡è¦çš„å‚æ•°ï¼š**

- **`corePoolSize` :** ä»»åŠ¡é˜Ÿåˆ—æœªè¾¾åˆ°é˜Ÿåˆ—å®¹é‡æ—¶ï¼Œæœ€å¤§å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚
- **`maximumPoolSize` :** ä»»åŠ¡é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡çš„æ—¶å€™ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡å˜ä¸ºæœ€å¤§çº¿ç¨‹æ•°ã€‚
- **`workQueue`:** æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚

`ThreadPoolExecutor`å…¶ä»–å¸¸è§å‚æ•° :

- **`keepAliveTime`**:çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº `corePoolSize` çš„æ—¶å€™ï¼Œå¦‚æœè¿™æ—¶æ²¡æœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œæ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹ä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä¼šç­‰å¾…ï¼Œç›´åˆ°ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº† `keepAliveTime`æ‰ä¼šè¢«å›æ”¶é”€æ¯ï¼›
- **`unit`** : `keepAliveTime` å‚æ•°çš„æ—¶é—´å•ä½ã€‚
- **`threadFactory`** :executor åˆ›å»ºæ–°çº¿ç¨‹çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚
- **`handler`** :é¥±å’Œç­–ç•¥ã€‚å…³äºé¥±å’Œç­–ç•¥ä¸‹é¢å•ç‹¬ä»‹ç»ä¸€ä¸‹ã€‚

ä¸‹é¢è¿™å¼ å›¾å¯ä»¥åŠ æ·±ä½ å¯¹çº¿ç¨‹æ± ä¸­å„ä¸ªå‚æ•°çš„ç›¸äº’å…³ç³»çš„ç†è§£ï¼ˆå›¾ç‰‡æ¥æºï¼šã€ŠJava æ€§èƒ½è°ƒä¼˜å®æˆ˜ã€‹ï¼‰ï¼š

![çº¿ç¨‹æ± å„ä¸ªå‚æ•°çš„å…³ç³»](../java-images/çº¿ç¨‹æ± å„ä¸ªå‚æ•°ä¹‹é—´çš„å…³ç³».d65f3309.png)



### çº¿ç¨‹æ± çš„é¥±å’Œç­–ç•¥æœ‰å“ªäº›ï¼Ÿ

å¦‚æœå½“å‰åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°é‡å¹¶ä¸”é˜Ÿåˆ—ä¹Ÿå·²ç»è¢«æ”¾æ»¡äº†ä»»åŠ¡æ—¶ï¼Œ`ThreadPoolTaskExecutor` å®šä¹‰ä¸€äº›ç­–ç•¥:

- **`ThreadPoolExecutor.AbortPolicy`ï¼š** æŠ›å‡º `RejectedExecutionException`æ¥æ‹’ç»æ–°ä»»åŠ¡çš„å¤„ç†ã€‚
- **`ThreadPoolExecutor.CallerRunsPolicy`ï¼š** è°ƒç”¨æ‰§è¡Œè‡ªå·±çš„çº¿ç¨‹è¿è¡Œä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥åœ¨è°ƒç”¨`execute`æ–¹æ³•çš„çº¿ç¨‹ä¸­è¿è¡Œ(`run`)è¢«æ‹’ç»çš„ä»»åŠ¡ï¼Œå¦‚æœæ‰§è¡Œç¨‹åºå·²å…³é—­ï¼Œåˆ™ä¼šä¸¢å¼ƒè¯¥ä»»åŠ¡ã€‚å› æ­¤è¿™ç§ç­–ç•¥ä¼šé™ä½å¯¹äºæ–°ä»»åŠ¡æäº¤é€Ÿåº¦ï¼Œå½±å“ç¨‹åºçš„æ•´ä½“æ€§èƒ½ã€‚å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºå¯ä»¥æ‰¿å—æ­¤å»¶è¿Ÿå¹¶ä¸”ä½ è¦æ±‚ä»»ä½•ä¸€ä¸ªä»»åŠ¡è¯·æ±‚éƒ½è¦è¢«æ‰§è¡Œçš„è¯ï¼Œä½ å¯ä»¥é€‰æ‹©è¿™ä¸ªç­–ç•¥ã€‚
- **`ThreadPoolExecutor.DiscardPolicy`ï¼š** ä¸å¤„ç†æ–°ä»»åŠ¡ï¼Œç›´æ¥ä¸¢å¼ƒæ‰ã€‚
- **`ThreadPoolExecutor.DiscardOldestPolicy`ï¼š** æ­¤ç­–ç•¥å°†ä¸¢å¼ƒæœ€æ—©çš„æœªå¤„ç†çš„ä»»åŠ¡è¯·æ±‚ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šSpring é€šè¿‡ `ThreadPoolTaskExecutor` æˆ–è€…æˆ‘ä»¬ç›´æ¥é€šè¿‡ `ThreadPoolExecutor` çš„æ„é€ å‡½æ•°åˆ›å»ºçº¿ç¨‹æ± çš„æ—¶å€™ï¼Œå½“æˆ‘ä»¬ä¸æŒ‡å®š `RejectedExecutionHandler` é¥±å’Œç­–ç•¥æ¥é…ç½®çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯ `AbortPolicy`ã€‚åœ¨è¿™ç§é¥±å’Œç­–ç•¥ä¸‹ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œ`ThreadPoolExecutor` å°†æŠ›å‡º `RejectedExecutionException` å¼‚å¸¸æ¥æ‹’ç»æ–°æ¥çš„ä»»åŠ¡ ï¼Œè¿™ä»£è¡¨ä½ å°†ä¸¢å¤±å¯¹è¿™ä¸ªä»»åŠ¡çš„å¤„ç†ã€‚å¦‚æœä¸æƒ³ä¸¢å¼ƒä»»åŠ¡çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨`CallerRunsPolicy`ã€‚`CallerRunsPolicy` å’Œå…¶ä»–çš„å‡ ä¸ªç­–ç•¥ä¸åŒï¼Œå®ƒæ—¢ä¸ä¼šæŠ›å¼ƒä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯å°†ä»»åŠ¡å›é€€ç»™è°ƒç”¨è€…ï¼Œä½¿ç”¨è°ƒç”¨è€…çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼š

```java
public static class CallerRunsPolicy implements RejectedExecutionHandler {
  
    public CallerRunsPolicy() { }

    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
        if (!e.isShutdown()) {
            // ç›´æ¥ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œè€Œä¸æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ‰§è¡Œ
            r.run();
        }
    }
}
```



### çº¿ç¨‹æ± å¸¸ç”¨çš„é˜»å¡é˜Ÿåˆ—æœ‰å“ªäº›ï¼Ÿ

æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚

ä¸åŒçš„çº¿ç¨‹æ± ä¼šé€‰ç”¨ä¸åŒçš„é˜»å¡é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥ç»“åˆå†…ç½®çº¿ç¨‹æ± æ¥åˆ†æã€‚

- å®¹é‡ä¸º `Integer.MAX_VALUE` çš„ `LinkedBlockingQueue`ï¼ˆæ— ç•Œé˜Ÿåˆ—ï¼‰ï¼š`FixedThreadPool` å’Œ `SingleThreadExector` ã€‚ç”±äºé˜Ÿåˆ—æ°¸è¿œä¸ä¼šè¢«æ”¾æ»¡ï¼Œå› æ­¤`FixedThreadPool`æœ€å¤šåªèƒ½åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹ã€‚
- `SynchronousQueue`ï¼ˆåŒæ­¥é˜Ÿåˆ—ï¼‰ ï¼š`CachedThreadPool` ã€‚`SynchronousQueue` æ²¡æœ‰å®¹é‡ï¼Œä¸å­˜å‚¨å…ƒç´ ï¼Œç›®çš„æ˜¯ä¿è¯å¯¹äºæäº¤çš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™ä½¿ç”¨ç©ºé—²çº¿ç¨‹æ¥å¤„ç†ï¼›å¦åˆ™æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`CachedThreadPool` çš„æœ€å¤§çº¿ç¨‹æ•°æ˜¯ `Integer.MAX_VALUE` ï¼Œå¯ä»¥ç†è§£ä¸ºçº¿ç¨‹æ•°æ˜¯å¯ä»¥æ— é™æ‰©å±•çš„ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
- `DelayedWorkQueue`ï¼ˆå»¶è¿Ÿé˜»å¡é˜Ÿåˆ—ï¼‰ï¼š`ScheduledThreadPool` å’Œ `SingleThreadScheduledExecutor` ã€‚`DelayedWorkQueue` çš„å†…éƒ¨å…ƒç´ å¹¶ä¸æ˜¯æŒ‰ç…§æ”¾å…¥çš„æ—¶é—´æ’åºï¼Œè€Œæ˜¯ä¼šæŒ‰ç…§å»¶è¿Ÿçš„æ—¶é—´é•¿çŸ­å¯¹ä»»åŠ¡è¿›è¡Œæ’åºï¼Œå†…éƒ¨é‡‡ç”¨çš„æ˜¯â€œå †â€çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥ä¿è¯æ¯æ¬¡å‡ºé˜Ÿçš„ä»»åŠ¡éƒ½æ˜¯å½“å‰é˜Ÿåˆ—ä¸­æ‰§è¡Œæ—¶é—´æœ€é å‰çš„ã€‚`DelayedWorkQueue` æ·»åŠ å…ƒç´ æ»¡äº†ä¹‹åä¼šè‡ªåŠ¨æ‰©å®¹åŸæ¥å®¹é‡çš„ 1/2ï¼Œå³æ°¸è¿œä¸ä¼šé˜»å¡ï¼Œæœ€å¤§æ‰©å®¹å¯è¾¾ `Integer.MAX_VALUE`ï¼Œæ‰€ä»¥æœ€å¤šåªèƒ½åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹ã€‚



### çº¿ç¨‹æ± å¤„ç†ä»»åŠ¡çš„æµç¨‹äº†è§£å—ï¼Ÿ

![å›¾è§£çº¿ç¨‹æ± å®ç°åŸç†](https://oss.javaguide.cn/javaguide/å›¾è§£çº¿ç¨‹æ± å®ç°åŸç†.png)

1. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå°±ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚
2. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°ç­‰äºæˆ–å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä½†æ˜¯å°äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå°±æŠŠè¯¥ä»»åŠ¡æ”¾å…¥åˆ°ä»»åŠ¡é˜Ÿåˆ—é‡Œç­‰å¾…æ‰§è¡Œã€‚
3. å¦‚æœå‘ä»»åŠ¡é˜Ÿåˆ—æŠ•æ”¾ä»»åŠ¡å¤±è´¥ï¼ˆä»»åŠ¡é˜Ÿåˆ—å·²ç»æ»¡äº†ï¼‰ï¼Œä½†æ˜¯å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°æ˜¯å°äºæœ€å¤§çº¿ç¨‹æ•°çš„ï¼Œå°±æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚
4. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å·²ç»ç­‰åŒäºæœ€å¤§çº¿ç¨‹æ•°äº†ï¼Œæ–°å»ºçº¿ç¨‹å°†ä¼šä½¿å½“å‰è¿è¡Œçš„çº¿ç¨‹è¶…å‡ºæœ€å¤§çº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå½“å‰ä»»åŠ¡ä¼šè¢«æ‹’ç»ï¼Œé¥±å’Œç­–ç•¥ä¼šè°ƒç”¨`RejectedExecutionHandler.rejectedExecution()`æ–¹æ³•ã€‚



### å¦‚ä½•ç»™çº¿ç¨‹æ± å‘½åï¼Ÿ

åˆå§‹åŒ–çº¿ç¨‹æ± çš„æ—¶å€™éœ€è¦æ˜¾ç¤ºå‘½åï¼ˆè®¾ç½®çº¿ç¨‹æ± åç§°å‰ç¼€ï¼‰ï¼Œæœ‰åˆ©äºå®šä½é—®é¢˜ã€‚

é»˜è®¤æƒ…å†µä¸‹åˆ›å»ºçš„çº¿ç¨‹åå­—ç±»ä¼¼ `pool-1-thread-n` è¿™æ ·çš„ï¼Œæ²¡æœ‰ä¸šåŠ¡å«ä¹‰ï¼Œä¸åˆ©äºæˆ‘ä»¬å®šä½é—®é¢˜ã€‚

ç»™çº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹å‘½åé€šå¸¸æœ‰ä¸‹é¢ä¸¤ç§æ–¹å¼ï¼š

**1ã€åˆ©ç”¨ guava çš„ `ThreadFactoryBuilder` **

```java
ThreadFactory threadFactory = new ThreadFactoryBuilder()
                        .setNameFormat(threadNamePrefix + "-%d")
                        .setDaemon(true).build();
ExecutorService threadPool = new ThreadPoolExecutor(corePoolSize, maximumPoolSize, keepAliveTime, TimeUnit.MINUTES, workQueue, threadFactory)
```

**2ã€è‡ªå·±å®ç° `ThreadFactor`ã€‚**

```java
import java.util.concurrent.Executors;
import java.util.concurrent.ThreadFactory;
import java.util.concurrent.atomic.AtomicInteger;
/**
 * çº¿ç¨‹å·¥å‚ï¼Œå®ƒè®¾ç½®çº¿ç¨‹åç§°ï¼Œæœ‰åˆ©äºæˆ‘ä»¬å®šä½é—®é¢˜ã€‚
 */
public final class NamingThreadFactory implements ThreadFactory {

    private final AtomicInteger threadNum = new AtomicInteger();
    private final ThreadFactory delegate;
    private final String name;

    /**
     * åˆ›å»ºä¸€ä¸ªå¸¦åå­—çš„çº¿ç¨‹æ± ç”Ÿäº§å·¥å‚
     */
    public NamingThreadFactory(ThreadFactory delegate, String name) {
        this.delegate = delegate;
        this.name = name; // TODO consider uniquifying this
    }

    @Override
    public Thread newThread(Runnable r) {
        Thread t = delegate.newThread(r);
        t.setName(name + " [#" + threadNum.incrementAndGet() + "]");
        return t;
    }

}
```



### å¦‚ä½•è®¾å®šçº¿ç¨‹æ± çš„å¤§å°ï¼Ÿ

å¾ˆå¤šäººç”šè‡³å¯èƒ½éƒ½ä¼šè§‰å¾—æŠŠçº¿ç¨‹æ± é…ç½®è¿‡å¤§ä¸€ç‚¹æ¯”è¾ƒå¥½ï¼æˆ‘è§‰å¾—è¿™æ˜æ˜¾æ˜¯æœ‰é—®é¢˜çš„ã€‚å°±æ‹¿æˆ‘ä»¬ç”Ÿæ´»ä¸­éå¸¸å¸¸è§çš„ä¸€ä¾‹å­æ¥è¯´ï¼š**å¹¶ä¸æ˜¯äººå¤šå°±èƒ½æŠŠäº‹æƒ…åšå¥½ï¼Œå¢åŠ äº†æ²Ÿé€šäº¤æµæˆæœ¬ã€‚ä½ æœ¬æ¥ä¸€ä»¶äº‹æƒ…åªéœ€è¦ 3 ä¸ªäººåšï¼Œä½ ç¡¬æ˜¯æ‹‰æ¥äº† 6 ä¸ªäººï¼Œä¼šæå‡åšäº‹æ•ˆç‡å˜›ï¼Ÿæˆ‘æƒ³å¹¶ä¸ä¼šã€‚** çº¿ç¨‹æ•°é‡è¿‡å¤šçš„å½±å“ä¹Ÿæ˜¯å’Œæˆ‘ä»¬åˆ†é…å¤šå°‘äººåšäº‹æƒ…ä¸€æ ·ï¼Œå¯¹äºå¤šçº¿ç¨‹è¿™ä¸ªåœºæ™¯æ¥è¯´ä¸»è¦æ˜¯å¢åŠ äº†**ä¸Šä¸‹æ–‡åˆ‡æ¢**æˆæœ¬ã€‚ä¸æ¸…æ¥šä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢çš„è¯ï¼Œå¯ä»¥çœ‹æˆ‘ä¸‹é¢çš„ä»‹ç»ã€‚

> ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š
>
> å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ä¸€èˆ¬çº¿ç¨‹çš„ä¸ªæ•°éƒ½å¤§äº CPU æ ¸å¿ƒçš„ä¸ªæ•°ï¼Œè€Œä¸€ä¸ª CPU æ ¸å¿ƒåœ¨ä»»æ„æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œä¸ºäº†è®©è¿™äº›çº¿ç¨‹éƒ½èƒ½å¾—åˆ°æœ‰æ•ˆæ‰§è¡Œï¼ŒCPU é‡‡å–çš„ç­–ç•¥æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…æ—¶é—´ç‰‡å¹¶è½®è½¬çš„å½¢å¼ã€‚å½“ä¸€ä¸ªçº¿ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œçš„æ—¶å€™å°±ä¼šé‡æ–°å¤„äºå°±ç»ªçŠ¶æ€è®©ç»™å…¶ä»–çº¿ç¨‹ä½¿ç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å±äºä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚æ¦‚æ‹¬æ¥è¯´å°±æ˜¯ï¼šå½“å‰ä»»åŠ¡åœ¨æ‰§è¡Œå®Œ CPU æ—¶é—´ç‰‡åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä»»åŠ¡ä¹‹å‰ä¼šå…ˆä¿å­˜è‡ªå·±çš„çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡å†åˆ‡æ¢å›è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œå¯ä»¥å†åŠ è½½è¿™ä¸ªä»»åŠ¡çš„çŠ¶æ€ã€‚**ä»»åŠ¡ä»ä¿å­˜åˆ°å†åŠ è½½çš„è¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢**ã€‚
>
> ä¸Šä¸‹æ–‡åˆ‡æ¢é€šå¸¸æ˜¯è®¡ç®—å¯†é›†å‹çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒéœ€è¦ç›¸å½“å¯è§‚çš„å¤„ç†å™¨æ—¶é—´ï¼Œåœ¨æ¯ç§’å‡ åä¸Šç™¾æ¬¡çš„åˆ‡æ¢ä¸­ï¼Œæ¯æ¬¡åˆ‡æ¢éƒ½éœ€è¦çº³ç§’é‡çº§çš„æ—¶é—´ã€‚æ‰€ä»¥ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¯¹ç³»ç»Ÿæ¥è¯´æ„å‘³ç€æ¶ˆè€—å¤§é‡çš„ CPU æ—¶é—´ï¼Œäº‹å®ä¸Šï¼Œå¯èƒ½æ˜¯æ“ä½œç³»ç»Ÿä¸­æ—¶é—´æ¶ˆè€—æœ€å¤§çš„æ“ä½œã€‚
>
> Linux ç›¸æ¯”ä¸å…¶ä»–æ“ä½œç³»ç»Ÿï¼ˆåŒ…æ‹¬å…¶ä»–ç±» Unix ç³»ç»Ÿï¼‰æœ‰å¾ˆå¤šçš„ä¼˜ç‚¹ï¼Œå…¶ä¸­æœ‰ä¸€é¡¹å°±æ˜¯ï¼Œå…¶ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ¨¡å¼åˆ‡æ¢çš„æ—¶é—´æ¶ˆè€—éå¸¸å°‘ã€‚

ç±»æ¯”äºå®ç°ä¸–ç•Œä¸­çš„äººç±»é€šè¿‡åˆä½œåšæŸä»¶äº‹æƒ…ï¼Œæˆ‘ä»¬å¯ä»¥è‚¯å®šçš„ä¸€ç‚¹æ˜¯çº¿ç¨‹æ± å¤§å°è®¾ç½®è¿‡å¤§æˆ–è€…è¿‡å°éƒ½ä¼šæœ‰é—®é¢˜ï¼Œåˆé€‚çš„æ‰æ˜¯æœ€å¥½ã€‚

- å¦‚æœæˆ‘ä»¬è®¾ç½®çš„çº¿ç¨‹æ± æ•°é‡å¤ªå°çš„è¯ï¼Œå¦‚æœåŒä¸€æ—¶é—´æœ‰å¤§é‡ä»»åŠ¡/è¯·æ±‚éœ€è¦å¤„ç†ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¤§é‡çš„è¯·æ±‚/ä»»åŠ¡åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­æ’é˜Ÿç­‰å¾…æ‰§è¡Œï¼Œç”šè‡³ä¼šå‡ºç°ä»»åŠ¡é˜Ÿåˆ—æ»¡äº†ä¹‹åä»»åŠ¡/è¯·æ±‚æ— æ³•å¤„ç†çš„æƒ…å†µï¼Œæˆ–è€…å¤§é‡ä»»åŠ¡å †ç§¯åœ¨ä»»åŠ¡é˜Ÿåˆ—å¯¼è‡´ OOMã€‚è¿™æ ·å¾ˆæ˜æ˜¾æ˜¯æœ‰é—®é¢˜çš„ï¼ŒCPU æ ¹æœ¬æ²¡æœ‰å¾—åˆ°å……åˆ†åˆ©ç”¨ã€‚
- å¦‚æœæˆ‘ä»¬è®¾ç½®çº¿ç¨‹æ•°é‡å¤ªå¤§ï¼Œå¤§é‡çº¿ç¨‹å¯èƒ½ä¼šåŒæ—¶åœ¨äº‰å– CPU èµ„æºï¼Œè¿™æ ·ä¼šå¯¼è‡´å¤§é‡çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»è€Œå¢åŠ çº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ï¼Œå½±å“äº†æ•´ä½“æ‰§è¡Œæ•ˆç‡ã€‚

æœ‰ä¸€ä¸ªç®€å•å¹¶ä¸”é€‚ç”¨é¢æ¯”è¾ƒå¹¿çš„å…¬å¼ï¼š

- **CPU å¯†é›†å‹ä»»åŠ¡(N+1)ï¼š** è¿™ç§ä»»åŠ¡æ¶ˆè€—çš„ä¸»è¦æ˜¯ CPU èµ„æºï¼Œå¯ä»¥å°†çº¿ç¨‹æ•°è®¾ç½®ä¸º Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰+1ã€‚æ¯” CPU æ ¸å¿ƒæ•°å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸ºäº†é˜²æ­¢çº¿ç¨‹å¶å‘çš„ç¼ºé¡µä¸­æ–­ï¼Œæˆ–è€…å…¶å®ƒåŸå› å¯¼è‡´çš„ä»»åŠ¡æš‚åœè€Œå¸¦æ¥çš„å½±å“ã€‚ä¸€æ—¦ä»»åŠ¡æš‚åœï¼ŒCPU å°±ä¼šå¤„äºç©ºé—²çŠ¶æ€ï¼Œè€Œåœ¨è¿™ç§æƒ…å†µä¸‹å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥å……åˆ†åˆ©ç”¨ CPU çš„ç©ºé—²æ—¶é—´ã€‚
- **I/O å¯†é›†å‹ä»»åŠ¡(2N)ï¼š** è¿™ç§ä»»åŠ¡åº”ç”¨èµ·æ¥ï¼Œç³»ç»Ÿä¼šç”¨å¤§éƒ¨åˆ†çš„æ—¶é—´æ¥å¤„ç† I/O äº¤äº’ï¼Œè€Œçº¿ç¨‹åœ¨å¤„ç† I/O çš„æ—¶é—´æ®µå†…ä¸ä¼šå ç”¨ CPU æ¥å¤„ç†ï¼Œè¿™æ—¶å°±å¯ä»¥å°† CPU äº¤å‡ºç»™å…¶å®ƒçº¿ç¨‹ä½¿ç”¨ã€‚å› æ­¤åœ¨ I/O å¯†é›†å‹ä»»åŠ¡çš„åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤šé…ç½®ä¸€äº›çº¿ç¨‹ï¼Œå…·ä½“çš„è®¡ç®—æ–¹æ³•æ˜¯ 2Nã€‚

**å¦‚ä½•åˆ¤æ–­æ˜¯ CPU å¯†é›†ä»»åŠ¡è¿˜æ˜¯ IO å¯†é›†ä»»åŠ¡ï¼Ÿ**

CPU å¯†é›†å‹ç®€å•ç†è§£å°±æ˜¯åˆ©ç”¨ CPU è®¡ç®—èƒ½åŠ›çš„ä»»åŠ¡æ¯”å¦‚ä½ åœ¨å†…å­˜ä¸­å¯¹å¤§é‡æ•°æ®è¿›è¡Œæ’åºã€‚ä½†å‡¡æ¶‰åŠåˆ°ç½‘ç»œè¯»å–ï¼Œæ–‡ä»¶è¯»å–è¿™ç±»éƒ½æ˜¯ IO å¯†é›†å‹ï¼Œè¿™ç±»ä»»åŠ¡çš„ç‰¹ç‚¹æ˜¯ CPU è®¡ç®—è€—è´¹æ—¶é—´ç›¸æ¯”äºç­‰å¾… IO æ“ä½œå®Œæˆçš„æ—¶é—´æ¥è¯´å¾ˆå°‘ï¼Œå¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨äº†ç­‰å¾… IO æ“ä½œå®Œæˆä¸Šã€‚

> ğŸŒˆ æ‹“å±•ä¸€ä¸‹ï¼ˆå‚è§ï¼š[issue#1737](https://github.com/Snailclimb/JavaGuide/issues/1737)ï¼‰ï¼š
>
> çº¿ç¨‹æ•°æ›´ä¸¥è°¨çš„è®¡ç®—çš„æ–¹æ³•åº”è¯¥æ˜¯ï¼š`æœ€ä½³çº¿ç¨‹æ•° = Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰âˆ—ï¼ˆ1+WTï¼ˆçº¿ç¨‹ç­‰å¾…æ—¶é—´ï¼‰/STï¼ˆçº¿ç¨‹è®¡ç®—æ—¶é—´ï¼‰ï¼‰`ï¼Œå…¶ä¸­ `WTï¼ˆçº¿ç¨‹ç­‰å¾…æ—¶é—´ï¼‰=çº¿ç¨‹è¿è¡Œæ€»æ—¶é—´ - STï¼ˆçº¿ç¨‹è®¡ç®—æ—¶é—´ï¼‰`ã€‚
>
> çº¿ç¨‹ç­‰å¾…æ—¶é—´æ‰€å æ¯”ä¾‹è¶Šé«˜ï¼Œéœ€è¦è¶Šå¤šçº¿ç¨‹ã€‚çº¿ç¨‹è®¡ç®—æ—¶é—´æ‰€å æ¯”ä¾‹è¶Šé«˜ï¼Œéœ€è¦è¶Šå°‘çº¿ç¨‹ã€‚
>
> æˆ‘ä»¬å¯ä»¥é€šè¿‡ JDK è‡ªå¸¦çš„å·¥å…· VisualVM æ¥æŸ¥çœ‹ `WT/ST` æ¯”ä¾‹ã€‚
>
> CPU å¯†é›†å‹ä»»åŠ¡çš„ `WT/ST` æ¥è¿‘æˆ–è€…ç­‰äº 0ï¼Œå› æ­¤ï¼Œ çº¿ç¨‹æ•°å¯ä»¥è®¾ç½®ä¸º Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰âˆ—ï¼ˆ1+0ï¼‰= Nï¼Œå’Œæˆ‘ä»¬ä¸Šé¢è¯´çš„ Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰+1 å·®ä¸å¤šã€‚
>
> IO å¯†é›†å‹ä»»åŠ¡ä¸‹ï¼Œå‡ ä¹å…¨æ˜¯çº¿ç¨‹ç­‰å¾…æ—¶é—´ï¼Œä»ç†è®ºä¸Šæ¥è¯´ï¼Œä½ å°±å¯ä»¥å°†çº¿ç¨‹æ•°è®¾ç½®ä¸º 2Nï¼ˆæŒ‰é“ç†æ¥è¯´ï¼ŒWT/ST çš„ç»“æœåº”è¯¥æ¯”è¾ƒå¤§ï¼Œè¿™é‡Œé€‰æ‹© 2N çš„åŸå› åº”è¯¥æ˜¯ä¸ºäº†é¿å…åˆ›å»ºè¿‡å¤šçº¿ç¨‹å§ï¼‰ã€‚

å…¬ç¤ºä¹Ÿåªæ˜¯å‚è€ƒï¼Œå…·ä½“è¿˜æ˜¯è¦æ ¹æ®é¡¹ç›®å®é™…çº¿ä¸Šè¿è¡Œæƒ…å†µæ¥åŠ¨æ€è°ƒæ•´ã€‚æˆ‘åœ¨åé¢ä»‹ç»çš„ç¾å›¢çš„çº¿ç¨‹æ± å‚æ•°åŠ¨æ€é…ç½®è¿™ç§æ–¹æ¡ˆå°±éå¸¸ä¸é”™ï¼Œå¾ˆå®ç”¨ï¼



### å¦‚ä½•åŠ¨æ€ä¿®æ”¹çº¿ç¨‹æ± çš„å‚æ•°ï¼Ÿ

ç¾å›¢æŠ€æœ¯å›¢é˜Ÿåœ¨[ã€ŠJava çº¿ç¨‹æ± å®ç°åŸç†åŠå…¶åœ¨ç¾å›¢ä¸šåŠ¡ä¸­çš„å®è·µã€‹](https://tech.meituan.com/2020/04/02/java-pooling-pratice-in-meituan.html)è¿™ç¯‡æ–‡ç« ä¸­ä»‹ç»åˆ°å¯¹çº¿ç¨‹æ± å‚æ•°å®ç°å¯è‡ªå®šä¹‰é…ç½®çš„æ€è·¯å’Œæ–¹æ³•ã€‚

ç¾å›¢æŠ€æœ¯å›¢é˜Ÿçš„æ€è·¯æ˜¯ä¸»è¦å¯¹çº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°å®ç°è‡ªå®šä¹‰å¯é…ç½®ã€‚è¿™ä¸‰ä¸ªæ ¸å¿ƒå‚æ•°æ˜¯ï¼š

- **`corePoolSize` :** æ ¸å¿ƒçº¿ç¨‹æ•°çº¿ç¨‹æ•°å®šä¹‰äº†æœ€å°å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚
- **`maximumPoolSize` :** å½“é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡çš„æ—¶å€™ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡å˜ä¸ºæœ€å¤§çº¿ç¨‹æ•°ã€‚
- **`workQueue`:** å½“æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚

**ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸‰ä¸ªå‚æ•°ï¼Ÿ**

æˆ‘åœ¨[Java çº¿ç¨‹æ± è¯¦è§£](https://javaguide.cn/java/concurrent/java-thread-pool-summary.html) è¿™ç¯‡æ–‡ç« ä¸­å°±è¯´è¿‡è¿™ä¸‰ä¸ªå‚æ•°æ˜¯ `ThreadPoolExecutor` æœ€é‡è¦çš„å‚æ•°ï¼Œå®ƒä»¬åŸºæœ¬å†³å®šäº†çº¿ç¨‹æ± å¯¹äºä»»åŠ¡çš„å¤„ç†ç­–ç•¥ã€‚

**å¦‚ä½•æ”¯æŒå‚æ•°åŠ¨æ€é…ç½®ï¼Ÿ** ä¸”çœ‹ `ThreadPoolExecutor` æä¾›çš„ä¸‹é¢è¿™äº›æ–¹æ³•ã€‚

![img](https://oss.javaguide.cn/github/javaguide/java/concurrent/threadpoolexecutor-methods.png)

æ ¼å¤–éœ€è¦æ³¨æ„çš„æ˜¯`corePoolSize`ï¼Œ ç¨‹åºè¿è¡ŒæœŸé—´çš„æ—¶å€™ï¼Œæˆ‘ä»¬è°ƒç”¨ `setCorePoolSizeï¼ˆï¼‰`è¿™ä¸ªæ–¹æ³•çš„è¯ï¼Œçº¿ç¨‹æ± ä¼šé¦–å…ˆåˆ¤æ–­å½“å‰å·¥ä½œçº¿ç¨‹æ•°æ˜¯å¦å¤§äº`corePoolSize`ï¼Œå¦‚æœå¤§äºçš„è¯å°±ä¼šå›æ”¶å·¥ä½œçº¿ç¨‹ã€‚

å¦å¤–ï¼Œä½ ä¹Ÿçœ‹åˆ°äº†ä¸Šé¢å¹¶æ²¡æœ‰åŠ¨æ€æŒ‡å®šé˜Ÿåˆ—é•¿åº¦çš„æ–¹æ³•ï¼Œç¾å›¢çš„æ–¹å¼æ˜¯è‡ªå®šä¹‰äº†ä¸€ä¸ªå«åš `ResizableCapacityLinkedBlockIngQueue` çš„é˜Ÿåˆ—ï¼ˆä¸»è¦å°±æ˜¯æŠŠ`LinkedBlockingQueue`çš„ capacity å­—æ®µçš„ final å…³é”®å­—ä¿®é¥°ç»™å»æ‰äº†ï¼Œè®©å®ƒå˜ä¸ºå¯å˜çš„ï¼‰ã€‚

æœ€ç»ˆå®ç°çš„å¯åŠ¨æ€ä¿®æ”¹çº¿ç¨‹æ± å‚æ•°æ•ˆæœå¦‚ä¸‹ã€‚ğŸ‘ğŸ‘ğŸ‘

![åŠ¨æ€é…ç½®çº¿ç¨‹æ± å‚æ•°æœ€ç»ˆæ•ˆæœ](https://oss.javaguide.cn/github/javaguide/java/concurrent/meituan-dynamically-configuring-thread-pool-parameters.png)

è¿˜æ²¡çœ‹å¤Ÿï¼Ÿæ¨è why ç¥çš„[å¦‚ä½•è®¾ç½®çº¿ç¨‹æ± å‚æ•°ï¼Ÿç¾å›¢ç»™å‡ºäº†ä¸€ä¸ªè®©é¢è¯•å®˜è™èº¯ä¸€éœ‡çš„å›ç­”ã€‚](https://mp.weixin.qq.com/s/9HLuPcoWmTqAeFKa1kj-_A)è¿™ç¯‡æ–‡ç« ï¼Œæ·±åº¦å‰–æï¼Œå¾ˆä¸é”™å“¦ï¼

å¦‚æœæˆ‘ä»¬çš„é¡¹ç›®ä¹Ÿæƒ³è¦å®ç°è¿™ç§æ•ˆæœçš„è¯ï¼Œå¯ä»¥å€ŸåŠ©ç°æˆçš„å¼€æºé¡¹ç›®ï¼š

- **[Hippo-4](https://github.com/opengoofy/hippo4j)** ï¼šä¸€æ¬¾å¼ºå¤§çš„åŠ¨æ€çº¿ç¨‹æ± æ¡†æ¶ï¼Œè§£å†³äº†ä¼ ç»Ÿçº¿ç¨‹æ± ä½¿ç”¨å­˜åœ¨çš„ä¸€äº›ç—›ç‚¹æ¯”å¦‚çº¿ç¨‹æ± å‚æ•°æ²¡åŠæ³•åŠ¨æ€ä¿®æ”¹ã€ä¸æ”¯æŒè¿è¡Œæ—¶å˜é‡çš„ä¼ é€’ã€æ— æ³•æ‰§è¡Œä¼˜é›…å…³é—­ã€‚é™¤äº†æ”¯æŒåŠ¨æ€ä¿®æ”¹çº¿ç¨‹æ± å‚æ•°ã€çº¿ç¨‹æ± ä»»åŠ¡ä¼ é€’ä¸Šä¸‹æ–‡ï¼Œè¿˜æ”¯æŒé€šçŸ¥æŠ¥è­¦ã€è¿è¡Œç›‘æ§ç­‰å¼€ç®±å³ç”¨çš„åŠŸèƒ½ã€‚
- **[Dynamic TP](https://github.com/dromara/dynamic-tp)** ï¼šè½»é‡çº§åŠ¨æ€çº¿ç¨‹æ± ï¼Œå†…ç½®ç›‘æ§å‘Šè­¦åŠŸèƒ½ï¼Œé›†æˆä¸‰æ–¹ä¸­é—´ä»¶çº¿ç¨‹æ± ç®¡ç†ï¼ŒåŸºäºä¸»æµé…ç½®ä¸­å¿ƒï¼ˆå·²æ”¯æŒNacosã€Apolloï¼ŒZookeeperã€Consulã€Etcdï¼Œå¯é€šè¿‡SPIè‡ªå®šä¹‰å®ç°ï¼‰ã€‚



### çº¿ç¨‹æ± ä»‹ç»

é¡¾åæ€ä¹‰ï¼Œçº¿ç¨‹æ± å°±æ˜¯ç®¡ç†ä¸€ç³»åˆ—çº¿ç¨‹çš„èµ„æºæ± ï¼Œå…¶æä¾›äº†ä¸€ç§é™åˆ¶å’Œç®¡ç†çº¿ç¨‹èµ„æºçš„æ–¹å¼ã€‚æ¯ä¸ªçº¿ç¨‹æ± è¿˜ç»´æŠ¤ä¸€äº›åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚å·²å®Œæˆä»»åŠ¡çš„æ•°é‡ã€‚

è¿™é‡Œå€Ÿç”¨ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ä¹¦ä¸­çš„éƒ¨åˆ†å†…å®¹æ¥æ€»ç»“ä¸€ä¸‹ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„ï¼š

- **é™ä½èµ„æºæ¶ˆè€—**ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚
- **æé«˜å“åº”é€Ÿåº¦**ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚
- **æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§**ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚

**çº¿ç¨‹æ± ä¸€èˆ¬ç”¨äºæ‰§è¡Œå¤šä¸ªä¸ç›¸å…³è”çš„è€—æ—¶ä»»åŠ¡ï¼Œæ²¡æœ‰å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œä»»åŠ¡é¡ºåºæ‰§è¡Œï¼Œä½¿ç”¨äº†çº¿ç¨‹æ± çš„è¯å¯è®©å¤šä¸ªä¸ç›¸å…³è”çš„ä»»åŠ¡åŒæ—¶æ‰§è¡Œã€‚**

å‡è®¾æˆ‘ä»¬è¦æ‰§è¡Œä¸‰ä¸ªä¸ç›¸å…³çš„è€—æ—¶ä»»åŠ¡ï¼Œç”»å›¾ç»™å¤§å®¶å±•ç¤ºäº†ä½¿ç”¨çº¿ç¨‹æ± å‰åçš„åŒºåˆ«ã€‚

æ³¨æ„ï¼š**ä¸‹é¢ä¸‰ä¸ªä»»åŠ¡å¯èƒ½åšçš„æ˜¯åŒä¸€ä»¶äº‹æƒ…ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸ä¸€æ ·çš„äº‹æƒ…ã€‚**

> ä½¿ç”¨å¤šçº¿ç¨‹å‰åº”ä¸ºï¼šä»»åŠ¡ 1 --> ä»»åŠ¡ 2 --> ä»»åŠ¡ 3ï¼ˆå›¾ä¸­æŠŠä»»åŠ¡ 3 ç”»é”™ä¸º ä»»åŠ¡ 2ï¼‰

![ä½¿ç”¨çº¿ç¨‹æ± å‰åå¯¹æ¯”](../java-images/1bc44c67-26ba-42ab-bcb8-4e29e6fd99b9.e5e38abf.png)



### Executor æ¡†æ¶ä»‹ç»



`Executor` æ¡†æ¶æ˜¯ Java5 ä¹‹åå¼•è¿›çš„ï¼Œåœ¨ Java 5 ä¹‹åï¼Œé€šè¿‡ `Executor` æ¥å¯åŠ¨çº¿ç¨‹æ¯”ä½¿ç”¨ `Thread` çš„ `start` æ–¹æ³•æ›´å¥½ï¼Œé™¤äº†æ›´æ˜“ç®¡ç†ï¼Œæ•ˆç‡æ›´å¥½ï¼ˆç”¨çº¿ç¨‹æ± å®ç°ï¼ŒèŠ‚çº¦å¼€é”€ï¼‰å¤–ï¼Œè¿˜æœ‰å…³é”®çš„ä¸€ç‚¹ï¼šæœ‰åŠ©äºé¿å… this é€ƒé€¸é—®é¢˜ã€‚

> this é€ƒé€¸æ˜¯æŒ‡åœ¨æ„é€ å‡½æ•°è¿”å›ä¹‹å‰å…¶ä»–çº¿ç¨‹å°±æŒæœ‰è¯¥å¯¹è±¡çš„å¼•ç”¨ï¼Œè°ƒç”¨å°šæœªæ„é€ å®Œå…¨çš„å¯¹è±¡çš„æ–¹æ³•å¯èƒ½å¼•å‘ä»¤äººç–‘æƒ‘çš„é”™è¯¯ã€‚

`Executor` æ¡†æ¶ä¸ä»…åŒ…æ‹¬äº†çº¿ç¨‹æ± çš„ç®¡ç†ï¼Œè¿˜æä¾›äº†çº¿ç¨‹å·¥å‚ã€é˜Ÿåˆ—ä»¥åŠæ‹’ç»ç­–ç•¥ç­‰ï¼Œ`Executor` æ¡†æ¶è®©å¹¶å‘ç¼–ç¨‹å˜å¾—æ›´åŠ ç®€å•ã€‚

`Executor` æ¡†æ¶ç»“æ„ä¸»è¦ç”±ä¸‰å¤§éƒ¨åˆ†ç»„æˆï¼š

**1ã€ä»»åŠ¡(`Runnable` /`Callable`)**

æ‰§è¡Œä»»åŠ¡éœ€è¦å®ç°çš„ **`Runnable` æ¥å£** æˆ– **`Callable`æ¥å£**ã€‚**`Runnable` æ¥å£**æˆ– **`Callable` æ¥å£** å®ç°ç±»éƒ½å¯ä»¥è¢« **`ThreadPoolExecutor`** æˆ– **`ScheduledThreadPoolExecutor`** æ‰§è¡Œã€‚

**2ã€ä»»åŠ¡çš„æ‰§è¡Œ(`Executor`)**

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒåŒ…æ‹¬ä»»åŠ¡æ‰§è¡Œæœºåˆ¶çš„æ ¸å¿ƒæ¥å£ **`Executor`** ï¼Œä»¥åŠç»§æ‰¿è‡ª `Executor` æ¥å£çš„ **`ExecutorService` æ¥å£ã€‚`ThreadPoolExecutor`** å’Œ **`ScheduledThreadPoolExecutor`** è¿™ä¸¤ä¸ªå…³é”®ç±»å®ç°äº† **`ExecutorService`** æ¥å£ã€‚

![image-20230411152540910](../java-images/image-20230411152540910.png)

è¿™é‡Œæäº†å¾ˆå¤šåº•å±‚çš„ç±»å…³ç³»ï¼Œä½†æ˜¯ï¼Œå®é™…ä¸Šæˆ‘ä»¬éœ€è¦æ›´å¤šå…³æ³¨çš„æ˜¯ `ThreadPoolExecutor` è¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»åœ¨æˆ‘ä»¬å®é™…ä½¿ç”¨çº¿ç¨‹æ± çš„è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨é¢‘ç‡è¿˜æ˜¯éå¸¸é«˜çš„ã€‚

**æ³¨æ„ï¼š** é€šè¿‡æŸ¥çœ‹ `ScheduledThreadPoolExecutor` æºä»£ç æˆ‘ä»¬å‘ç° `ScheduledThreadPoolExecutor` å®é™…ä¸Šæ˜¯ç»§æ‰¿äº† `ThreadPoolExecutor` å¹¶å®ç°äº† `ScheduledExecutorService` ï¼Œè€Œ `ScheduledExecutorService` åˆå®ç°äº† `ExecutorService`ï¼Œæ­£å¦‚æˆ‘ä»¬ä¸Šé¢ç»™å‡ºçš„ç±»å…³ç³»å›¾æ˜¾ç¤ºçš„ä¸€æ ·ã€‚

`ThreadPoolExecutor` ç±»æè¿°ï¼š

```java
//AbstractExecutorServiceå®ç°äº†ExecutorServiceæ¥å£
public class ThreadPoolExecutor extends AbstractExecutorService
```

`ScheduledThreadPoolExecutor` ç±»æè¿°:

```java
//ScheduledExecutorServiceç»§æ‰¿ExecutorServiceæ¥å£
public class ScheduledThreadPoolExecutor
        extends ThreadPoolExecutor
        implements ScheduledExecutorService
```

**3ã€å¼‚æ­¥è®¡ç®—çš„ç»“æœï¼ˆ`Future`ï¼‰**

**`Future`** æ¥å£ä»¥åŠ `Future` æ¥å£çš„å®ç°ç±» **`FutureTask`** ç±»éƒ½å¯ä»¥ä»£è¡¨å¼‚æ­¥è®¡ç®—çš„ç»“æœã€‚

å½“æˆ‘ä»¬æŠŠ **`Runnable`æ¥å£** æˆ– **`Callable` æ¥å£** çš„å®ç°ç±»æäº¤ç»™ **`ThreadPoolExecutor`** æˆ– **`ScheduledThreadPoolExecutor`** æ‰§è¡Œã€‚ï¼ˆè°ƒç”¨ `submit()` æ–¹æ³•æ—¶ä¼šè¿”å›ä¸€ä¸ª **`FutureTask`** å¯¹è±¡ï¼‰

**`Executor` æ¡†æ¶çš„ä½¿ç”¨ç¤ºæ„å›¾** ï¼š

![Executor æ¡†æ¶çš„ä½¿ç”¨ç¤ºæ„å›¾](../java-images/Executoræ¡†æ¶çš„ä½¿ç”¨ç¤ºæ„å›¾.36e59afa.png)

1. ä¸»çº¿ç¨‹é¦–å…ˆè¦åˆ›å»ºå®ç° `Runnable` æˆ–è€… `Callable` æ¥å£çš„ä»»åŠ¡å¯¹è±¡ã€‚
2. æŠŠåˆ›å»ºå®Œæˆçš„å®ç° `Runnable`/`Callable`æ¥å£çš„ å¯¹è±¡ç›´æ¥äº¤ç»™ `ExecutorService` æ‰§è¡Œ: `ExecutorService.execute(Runnable command)`ï¼‰æˆ–è€…ä¹Ÿå¯ä»¥æŠŠ `Runnable` å¯¹è±¡æˆ–`Callable` å¯¹è±¡æäº¤ç»™ `ExecutorService` æ‰§è¡Œï¼ˆ`ExecutorService.submitï¼ˆRunnable taskï¼‰`æˆ– `ExecutorService.submit(Callable <T> task)`ï¼‰ã€‚
3. å¦‚æœæ‰§è¡Œ `ExecutorService.submit(â€¦)`ï¼Œ`ExecutorService` å°†è¿”å›ä¸€ä¸ªå®ç°`Future`æ¥å£çš„å¯¹è±¡ï¼ˆæˆ‘ä»¬åˆšåˆšä¹Ÿæåˆ°è¿‡äº†æ‰§è¡Œ `execute()`æ–¹æ³•å’Œ `submit()`æ–¹æ³•çš„åŒºåˆ«ï¼Œ`submit()`ä¼šè¿”å›ä¸€ä¸ª `FutureTask` å¯¹è±¡ï¼‰ã€‚ç”±äº `FutureTask` å®ç°äº† `Runnable`ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»º `FutureTask`ï¼Œç„¶åç›´æ¥äº¤ç»™ `ExecutorService` æ‰§è¡Œã€‚
4. æœ€åï¼Œä¸»çº¿ç¨‹å¯ä»¥æ‰§è¡Œ `FutureTask.get()`æ–¹æ³•æ¥ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚ä¸»çº¿ç¨‹ä¹Ÿå¯ä»¥æ‰§è¡Œ `FutureTask.cancel(boolean mayInterruptIfRunning)`æ¥å–æ¶ˆæ­¤ä»»åŠ¡çš„æ‰§è¡Œã€‚



### â­ThreadPoolExecutor ç±»ä»‹ç»

çº¿ç¨‹æ± å®ç°ç±» `ThreadPoolExecutor` æ˜¯ `Executor` æ¡†æ¶æœ€æ ¸å¿ƒçš„ç±»ã€‚

#### æ„é€ æ–¹æ³•ä»‹ç»

`ThreadPoolExecutor` ç±»ä¸­æä¾›çš„å››ä¸ªæ„é€ æ–¹æ³•ã€‚æˆ‘ä»¬æ¥çœ‹æœ€é•¿çš„é‚£ä¸ªï¼Œå…¶ä½™ä¸‰ä¸ªéƒ½æ˜¯åœ¨è¿™ä¸ªæ„é€ æ–¹æ³•çš„åŸºç¡€ä¸Šäº§ç”Ÿï¼ˆå…¶ä»–å‡ ä¸ªæ„é€ æ–¹æ³•è¯´ç™½ç‚¹éƒ½æ˜¯ç»™å®šæŸäº›é»˜è®¤å‚æ•°çš„æ„é€ æ–¹æ³•æ¯”å¦‚é»˜è®¤åˆ¶å®šæ‹’ç»ç­–ç•¥æ˜¯ä»€ä¹ˆï¼‰ã€‚

```java
/**
     * ç”¨ç»™å®šçš„åˆå§‹å‚æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadPoolExecutorã€‚
     */
public ThreadPoolExecutor(int corePoolSize,//çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡
                          int maximumPoolSize,//çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°
                          long keepAliveTime,//å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹å­˜æ´»çš„æœ€é•¿æ—¶é—´
                          TimeUnit unit,//æ—¶é—´å•ä½
                          BlockingQueue<Runnable> workQueue,//ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨æ¥å‚¨å­˜ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„é˜Ÿåˆ—
                          ThreadFactory threadFactory,//çº¿ç¨‹å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬é»˜è®¤å³å¯
                          RejectedExecutionHandler handler//æ‹’ç»ç­–ç•¥ï¼Œå½“æäº¤çš„ä»»åŠ¡è¿‡å¤šè€Œä¸èƒ½åŠæ—¶å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶ç­–ç•¥æ¥å¤„ç†ä»»åŠ¡
                         ) {
    if (corePoolSize < 0 ||
        maximumPoolSize <= 0 ||
        maximumPoolSize < corePoolSize ||
        keepAliveTime < 0)
        throw new IllegalArgumentException();
    if (workQueue == null || threadFactory == null || handler == null)
        throw new NullPointerException();
    this.corePoolSize = corePoolSize;
    this.maximumPoolSize = maximumPoolSize;
    this.workQueue = workQueue;
    this.keepAliveTime = unit.toNanos(keepAliveTime);
    this.threadFactory = threadFactory;
    this.handler = handler;
}
```

ä¸‹é¢è¿™äº›å¯¹åˆ›å»ºéå¸¸é‡è¦ï¼Œåœ¨åé¢ä½¿ç”¨çº¿ç¨‹æ± çš„è¿‡ç¨‹ä¸­ä½ ä¸€å®šä¼šç”¨åˆ°ï¼æ‰€ä»¥ï¼ŒåŠ¡å¿…æ‹¿ç€å°æœ¬æœ¬è®°æ¸…æ¥šã€‚

**`ThreadPoolExecutor` 3 ä¸ªæœ€é‡è¦çš„å‚æ•°ï¼š**

- **`corePoolSize` :** ä»»åŠ¡é˜Ÿåˆ—æœªè¾¾åˆ°é˜Ÿåˆ—å®¹é‡æ—¶ï¼Œæœ€å¤§å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡ã€‚
- **`maximumPoolSize` :** ä»»åŠ¡é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡çš„æ—¶å€™ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡å˜ä¸ºæœ€å¤§çº¿ç¨‹æ•°ã€‚
- **`workQueue`:** æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚

`ThreadPoolExecutor`å…¶ä»–å¸¸è§å‚æ•° :

- **`keepAliveTime`**:çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº `corePoolSize` çš„æ—¶å€™ï¼Œå¦‚æœè¿™æ—¶æ²¡æœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œæ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹ä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä¼šç­‰å¾…ï¼Œç›´åˆ°ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº† `keepAliveTime`æ‰ä¼šè¢«å›æ”¶é”€æ¯ã€‚
- **`unit`** : `keepAliveTime` å‚æ•°çš„æ—¶é—´å•ä½ã€‚
- **`threadFactory`** :executor åˆ›å»ºæ–°çº¿ç¨‹çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚
- **`handler`** :é¥±å’Œç­–ç•¥ã€‚å…³äºé¥±å’Œç­–ç•¥ä¸‹é¢å•ç‹¬ä»‹ç»ä¸€ä¸‹ã€‚

ä¸‹é¢è¿™å¼ å›¾å¯ä»¥åŠ æ·±ä½ å¯¹çº¿ç¨‹æ± ä¸­å„ä¸ªå‚æ•°çš„ç›¸äº’å…³ç³»çš„ç†è§£ï¼ˆå›¾ç‰‡æ¥æºï¼šã€ŠJava æ€§èƒ½è°ƒä¼˜å®æˆ˜ã€‹ï¼‰ï¼š

![çº¿ç¨‹æ± å„ä¸ªå‚æ•°çš„å…³ç³»](../java-images/çº¿ç¨‹æ± å„ä¸ªå‚æ•°ä¹‹é—´çš„å…³ç³».d65f3309.png)

**`ThreadPoolExecutor` é¥±å’Œç­–ç•¥å®šä¹‰:**

å¦‚æœå½“å‰åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°é‡å¹¶ä¸”é˜Ÿåˆ—ä¹Ÿå·²ç»è¢«æ”¾æ»¡äº†ä»»åŠ¡æ—¶ï¼Œ`ThreadPoolTaskExecutor` å®šä¹‰ä¸€äº›ç­–ç•¥ï¼š

- **`ThreadPoolExecutor.AbortPolicy`** ï¼šæŠ›å‡º `RejectedExecutionException`æ¥æ‹’ç»æ–°ä»»åŠ¡çš„å¤„ç†ã€‚
- **`ThreadPoolExecutor.CallerRunsPolicy`** ï¼šè°ƒç”¨æ‰§è¡Œè‡ªå·±çš„çº¿ç¨‹è¿è¡Œä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥åœ¨è°ƒç”¨`execute`æ–¹æ³•çš„çº¿ç¨‹ä¸­è¿è¡Œ(`run`)è¢«æ‹’ç»çš„ä»»åŠ¡ï¼Œå¦‚æœæ‰§è¡Œç¨‹åºå·²å…³é—­ï¼Œåˆ™ä¼šä¸¢å¼ƒè¯¥ä»»åŠ¡ã€‚å› æ­¤è¿™ç§ç­–ç•¥ä¼šé™ä½å¯¹äºæ–°ä»»åŠ¡æäº¤é€Ÿåº¦ï¼Œå½±å“ç¨‹åºçš„æ•´ä½“æ€§èƒ½ã€‚å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºå¯ä»¥æ‰¿å—æ­¤å»¶è¿Ÿå¹¶ä¸”ä½ è¦æ±‚ä»»ä½•ä¸€ä¸ªä»»åŠ¡è¯·æ±‚éƒ½è¦è¢«æ‰§è¡Œçš„è¯ï¼Œä½ å¯ä»¥é€‰æ‹©è¿™ä¸ªç­–ç•¥ã€‚
- **`ThreadPoolExecutor.DiscardPolicy`** ï¼šä¸å¤„ç†æ–°ä»»åŠ¡ï¼Œç›´æ¥ä¸¢å¼ƒæ‰ã€‚
- **`ThreadPoolExecutor.DiscardOldestPolicy`** ï¼š æ­¤ç­–ç•¥å°†ä¸¢å¼ƒæœ€æ—©çš„æœªå¤„ç†çš„ä»»åŠ¡è¯·æ±‚ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

Spring é€šè¿‡ `ThreadPoolTaskExecutor` æˆ–è€…æˆ‘ä»¬ç›´æ¥é€šè¿‡ `ThreadPoolExecutor` çš„æ„é€ å‡½æ•°åˆ›å»ºçº¿ç¨‹æ± çš„æ—¶å€™ï¼Œå½“æˆ‘ä»¬ä¸æŒ‡å®š `RejectedExecutionHandler` é¥±å’Œç­–ç•¥çš„è¯æ¥é…ç½®çº¿ç¨‹æ± çš„æ—¶å€™é»˜è®¤ä½¿ç”¨çš„æ˜¯ `ThreadPoolExecutor.AbortPolicy`ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ`ThreadPoolExecutor` å°†æŠ›å‡º `RejectedExecutionException` æ¥æ‹’ç»æ–°æ¥çš„ä»»åŠ¡ ï¼Œè¿™ä»£è¡¨ä½ å°†ä¸¢å¤±å¯¹è¿™ä¸ªä»»åŠ¡çš„å¤„ç†ã€‚ å¯¹äºå¯ä¼¸ç¼©çš„åº”ç”¨ç¨‹åºï¼Œå»ºè®®ä½¿ç”¨ `ThreadPoolExecutor.CallerRunsPolicy`ã€‚å½“æœ€å¤§æ± è¢«å¡«æ»¡æ—¶ï¼Œæ­¤ç­–ç•¥ä¸ºæˆ‘ä»¬æä¾›å¯ä¼¸ç¼©é˜Ÿåˆ—ï¼ˆè¿™ä¸ªç›´æ¥æŸ¥çœ‹ `ThreadPoolExecutor` çš„æ„é€ å‡½æ•°æºç å°±å¯ä»¥çœ‹å‡ºï¼Œæ¯”è¾ƒç®€å•çš„åŸå› ï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†ï¼‰ã€‚



### â­çº¿ç¨‹æ± åŸç†åˆ†æ

æˆ‘ä»¬ä¸Šé¢è®²è§£äº† `Executor`æ¡†æ¶ä»¥åŠ `ThreadPoolExecutor` ç±»ï¼Œä¸‹é¢è®©æˆ‘ä»¬å®æˆ˜ä¸€ä¸‹ï¼Œæ¥é€šè¿‡å†™ä¸€ä¸ª `ThreadPoolExecutor` çš„å° Demo æ¥å›é¡¾ä¸Šé¢çš„å†…å®¹ã€‚

##### ThreadPoolExecutor ç¤ºä¾‹ä»£ç 

é¦–å…ˆåˆ›å»ºä¸€ä¸ª `Runnable` æ¥å£çš„å®ç°ç±»ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥æ˜¯ `Callable` æ¥å£ï¼Œæˆ‘ä»¬ä¸Šé¢ä¹Ÿè¯´äº†ä¸¤è€…çš„åŒºåˆ«ã€‚ï¼‰

`MyRunnable.java`

```java
import java.util.Date;

/**
 * è¿™æ˜¯ä¸€ä¸ªç®€å•çš„Runnableç±»ï¼Œéœ€è¦å¤§çº¦5ç§’é’Ÿæ¥æ‰§è¡Œå…¶ä»»åŠ¡ã€‚
 * @author shuang.kou
 */
public class MyRunnable implements Runnable {

    private String command;

    public MyRunnable(String s) {
        this.command = s;
    }

    @Override
    public void run() {
        System.out.println(Thread.currentThread().getName() + " Start. Time = " + new Date());
        processCommand();
        System.out.println(Thread.currentThread().getName() + " End. Time = " + new Date());
    }

    private void processCommand() {
        try {
            Thread.sleep(5000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

    @Override
    public String toString() {
        return this.command;
    }
}
```

ç¼–å†™æµ‹è¯•ç¨‹åºï¼Œæˆ‘ä»¬è¿™é‡Œä»¥é˜¿é‡Œå·´å·´æ¨èçš„ä½¿ç”¨ `ThreadPoolExecutor` æ„é€ å‡½æ•°è‡ªå®šä¹‰å‚æ•°çš„æ–¹å¼æ¥åˆ›å»ºçº¿ç¨‹æ± ã€‚

`ThreadPoolExecutorDemo.java`

```java
import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

public class ThreadPoolExecutorDemo {

    private static final int CORE_POOL_SIZE = 5;
    private static final int MAX_POOL_SIZE = 10;
    private static final int QUEUE_CAPACITY = 100;
    private static final Long KEEP_ALIVE_TIME = 1L;
    public static void main(String[] args) {

        //ä½¿ç”¨é˜¿é‡Œå·´å·´æ¨èçš„åˆ›å»ºçº¿ç¨‹æ± çš„æ–¹å¼
        //é€šè¿‡ThreadPoolExecutoræ„é€ å‡½æ•°è‡ªå®šä¹‰å‚æ•°åˆ›å»º
        ThreadPoolExecutor executor = new ThreadPoolExecutor(
                CORE_POOL_SIZE,
                MAX_POOL_SIZE,
                KEEP_ALIVE_TIME,
                TimeUnit.SECONDS,
                new ArrayBlockingQueue<>(QUEUE_CAPACITY),
                new ThreadPoolExecutor.CallerRunsPolicy());

        for (int i = 0; i < 10; i++) {
            //åˆ›å»ºWorkerThreadå¯¹è±¡ï¼ˆWorkerThreadç±»å®ç°äº†Runnable æ¥å£ï¼‰
            Runnable worker = new MyRunnable("" + i);
            //æ‰§è¡ŒRunnable
            executor.execute(worker);
        }
        //ç»ˆæ­¢çº¿ç¨‹æ± 
        executor.shutdown();
        while (!executor.isTerminated()) {
        }
        System.out.println("Finished all threads");
    }
}
```

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¸Šé¢çš„ä»£ç æŒ‡å®šäº†ï¼š

- `corePoolSize`: æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 5ã€‚
- `maximumPoolSize` ï¼šæœ€å¤§çº¿ç¨‹æ•° 10
- `keepAliveTime` : ç­‰å¾…æ—¶é—´ä¸º 1Lã€‚
- `unit`: ç­‰å¾…æ—¶é—´çš„å•ä½ä¸º TimeUnit.SECONDSã€‚
- `workQueue`ï¼šä»»åŠ¡é˜Ÿåˆ—ä¸º `ArrayBlockingQueue`ï¼Œå¹¶ä¸”å®¹é‡ä¸º 100;
- `handler`:é¥±å’Œç­–ç•¥ä¸º `CallerRunsPolicy`ã€‚

**è¾“å‡ºç»“æ„** ï¼š

```text
pool-1-thread-3 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-5 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-2 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-1 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-4 Start. Time = Sun Apr 12 11:14:37 CST 2020
pool-1-thread-3 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-4 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-1 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-5 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-1 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-2 End. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-5 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-4 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-3 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-2 Start. Time = Sun Apr 12 11:14:42 CST 2020
pool-1-thread-1 End. Time = Sun Apr 12 11:14:47 CST 2020
pool-1-thread-4 End. Time = Sun Apr 12 11:14:47 CST 2020
pool-1-thread-5 End. Time = Sun Apr 12 11:14:47 CST 2020
pool-1-thread-3 End. Time = Sun Apr 12 11:14:47 CST 2020
pool-1-thread-2 End. Time = Sun Apr 12 11:14:47 CST 2020
```



##### çº¿ç¨‹æ± åŸç†åˆ†æ

æˆ‘ä»¬é€šè¿‡å‰é¢çš„ä»£ç è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼š**çº¿ç¨‹æ± é¦–å…ˆä¼šå…ˆæ‰§è¡Œ 5 ä¸ªä»»åŠ¡ï¼Œç„¶åè¿™äº›ä»»åŠ¡æœ‰ä»»åŠ¡è¢«æ‰§è¡Œå®Œçš„è¯ï¼Œå°±ä¼šå»æ‹¿æ–°çš„ä»»åŠ¡æ‰§è¡Œã€‚** å¤§å®¶å¯ä»¥å…ˆé€šè¿‡ä¸Šé¢è®²è§£çš„å†…å®¹ï¼Œåˆ†æä¸€ä¸‹åˆ°åº•æ˜¯å’‹å›äº‹ï¼Ÿï¼ˆè‡ªå·±ç‹¬ç«‹æ€è€ƒä¸€ä¼šï¼‰

ç°åœ¨ï¼Œæˆ‘ä»¬å°±åˆ†æä¸Šé¢çš„è¾“å‡ºå†…å®¹æ¥ç®€å•åˆ†æä¸€ä¸‹çº¿ç¨‹æ± åŸç†ã€‚

ä¸ºäº†ææ‡‚çº¿ç¨‹æ± çš„åŸç†ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆåˆ†æä¸€ä¸‹ `execute`æ–¹æ³•ã€‚ åœ¨ç¤ºä¾‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `executor.execute(worker)`æ¥æäº¤ä¸€ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­å»ã€‚

è¿™ä¸ªæ–¹æ³•éå¸¸é‡è¦ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„æºç ï¼š

```java
// å­˜æ”¾çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ (runState) å’Œçº¿ç¨‹æ± å†…æœ‰æ•ˆçº¿ç¨‹çš„æ•°é‡ (workerCount)
private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));

private static int workerCountOf(int c) {
    return c & CAPACITY;
}
//ä»»åŠ¡é˜Ÿåˆ—
private final BlockingQueue<Runnable> workQueue;

public void execute(Runnable command) {
    // å¦‚æœä»»åŠ¡ä¸ºnullï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚
    if (command == null)
        throw new NullPointerException();
    // ctl ä¸­ä¿å­˜çš„çº¿ç¨‹æ± å½“å‰çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯
    int c = ctl.get();

    //  ä¸‹é¢ä¼šæ¶‰åŠåˆ° 3 æ­¥ æ“ä½œ
    // 1.é¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ± ä¸­æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡æ˜¯å¦å°äº corePoolSize
    // å¦‚æœå°äºçš„è¯ï¼Œé€šè¿‡addWorker(command, true)æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶å°†ä»»åŠ¡(command)æ·»åŠ åˆ°è¯¥çº¿ç¨‹ä¸­ï¼›ç„¶åï¼Œå¯åŠ¨è¯¥çº¿ç¨‹ä»è€Œæ‰§è¡Œä»»åŠ¡ã€‚
    if (workerCountOf(c) < corePoolSize) {
        if (addWorker(command, true))
            return;
        c = ctl.get();
    }
    // 2.å¦‚æœå½“å‰æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡å¤§äºç­‰äº corePoolSize çš„æ—¶å€™å°±ä¼šèµ°åˆ°è¿™é‡Œï¼Œè¡¨æ˜åˆ›å»ºæ–°çš„çº¿ç¨‹å¤±è´¥ã€‚
    // é€šè¿‡ isRunning æ–¹æ³•åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€ï¼Œçº¿ç¨‹æ± å¤„äº RUNNING çŠ¶æ€å¹¶ä¸”é˜Ÿåˆ—å¯ä»¥åŠ å…¥ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡æ‰ä¼šè¢«åŠ å…¥è¿›å»
    if (isRunning(c) && workQueue.offer(command)) {
        int recheck = ctl.get();
        // å†æ¬¡è·å–çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯ RUNNING çŠ¶æ€å°±éœ€è¦ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤ä»»åŠ¡ï¼Œå¹¶å°è¯•åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ã€‚åŒæ—¶æ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚
        if (!isRunning(recheck) && remove(command))
            reject(command);
        // å¦‚æœå½“å‰å·¥ä½œçº¿ç¨‹æ•°é‡ä¸º0ï¼Œæ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¹¶æ‰§è¡Œã€‚
        else if (workerCountOf(recheck) == 0)
            addWorker(null, false);
    }
    //3. é€šè¿‡addWorker(command, false)æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶å°†ä»»åŠ¡(command)æ·»åŠ åˆ°è¯¥çº¿ç¨‹ä¸­ï¼›ç„¶åï¼Œå¯åŠ¨è¯¥çº¿ç¨‹ä»è€Œæ‰§è¡Œä»»åŠ¡ã€‚
    // ä¼ å…¥ false ä»£è¡¨å¢åŠ çº¿ç¨‹æ—¶åˆ¤æ–­å½“å‰çº¿ç¨‹æ•°æ˜¯å¦å°‘äº maxPoolSize
    //å¦‚æœaddWorker(command, false)æ‰§è¡Œå¤±è´¥ï¼Œåˆ™é€šè¿‡reject()æ‰§è¡Œç›¸åº”çš„æ‹’ç»ç­–ç•¥çš„å†…å®¹ã€‚
    else if (!addWorker(command, false))
        reject(command);
}
```

è¿™é‡Œç®€å•åˆ†æä¸€ä¸‹æ•´ä¸ªæµç¨‹ï¼ˆå¯¹æ•´ä¸ªé€»è¾‘è¿›è¡Œäº†ç®€åŒ–ï¼Œæ–¹ä¾¿ç†è§£ï¼‰ï¼š

1. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå°±ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚
2. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°ç­‰äºæˆ–å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä½†æ˜¯å°äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå°±æŠŠè¯¥ä»»åŠ¡æ”¾å…¥åˆ°ä»»åŠ¡é˜Ÿåˆ—é‡Œç­‰å¾…æ‰§è¡Œã€‚
3. å¦‚æœå‘ä»»åŠ¡é˜Ÿåˆ—æŠ•æ”¾ä»»åŠ¡å¤±è´¥ï¼ˆä»»åŠ¡é˜Ÿåˆ—å·²ç»æ»¡äº†ï¼‰ï¼Œä½†æ˜¯å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°æ˜¯å°äºæœ€å¤§çº¿ç¨‹æ•°çš„ï¼Œå°±æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚
4. å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å·²ç»ç­‰åŒäºæœ€å¤§çº¿ç¨‹æ•°äº†ï¼Œæ–°å»ºçº¿ç¨‹å°†ä¼šä½¿å½“å‰è¿è¡Œçš„çº¿ç¨‹è¶…å‡ºæœ€å¤§çº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆå½“å‰ä»»åŠ¡ä¼šè¢«æ‹’ç»ï¼Œé¥±å’Œç­–ç•¥ä¼šè°ƒç”¨`RejectedExecutionHandler.rejectedExecution()`æ–¹æ³•ã€‚

![å›¾è§£çº¿ç¨‹æ± å®ç°åŸç†](../java-images/å›¾è§£çº¿ç¨‹æ± å®ç°åŸç†.png)

åœ¨ `execute` æ–¹æ³•ä¸­ï¼Œå¤šæ¬¡è°ƒç”¨ `addWorker` æ–¹æ³•ã€‚`addWorker` è¿™ä¸ªæ–¹æ³•ä¸»è¦ç”¨æ¥åˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹ï¼Œå¦‚æœè¿”å› true è¯´æ˜åˆ›å»ºå’Œå¯åŠ¨å·¥ä½œçº¿ç¨‹æˆåŠŸï¼Œå¦åˆ™çš„è¯è¿”å›çš„å°±æ˜¯ falseã€‚



```java
    // å…¨å±€é”ï¼Œå¹¶å‘æ“ä½œå¿…å¤‡
    private final ReentrantLock mainLock = new ReentrantLock();
    // è·Ÿè¸ªçº¿ç¨‹æ± çš„æœ€å¤§å¤§å°ï¼Œåªæœ‰åœ¨æŒæœ‰å…¨å±€é”mainLockçš„å‰æä¸‹æ‰èƒ½è®¿é—®æ­¤é›†åˆ
    private int largestPoolSize;
    // å·¥ä½œçº¿ç¨‹é›†åˆï¼Œå­˜æ”¾çº¿ç¨‹æ± ä¸­æ‰€æœ‰çš„ï¼ˆæ´»è·ƒçš„ï¼‰å·¥ä½œçº¿ç¨‹ï¼Œåªæœ‰åœ¨æŒæœ‰å…¨å±€é”mainLockçš„å‰æä¸‹æ‰èƒ½è®¿é—®æ­¤é›†åˆ
    private final HashSet<Worker> workers = new HashSet<>();
    //è·å–çº¿ç¨‹æ± çŠ¶æ€
    private static int runStateOf(int c)     { return c & ~CAPACITY; }
    //åˆ¤æ–­çº¿ç¨‹æ± çš„çŠ¶æ€æ˜¯å¦ä¸º Running
    private static boolean isRunning(int c) {
        return c < SHUTDOWN;
    }


    /**
     * æ·»åŠ æ–°çš„å·¥ä½œçº¿ç¨‹åˆ°çº¿ç¨‹æ± 
     * @param firstTask è¦æ‰§è¡Œ
     * @param coreå‚æ•°ä¸ºtrueçš„è¯è¡¨ç¤ºä½¿ç”¨çº¿ç¨‹æ± çš„åŸºæœ¬å¤§å°ï¼Œä¸ºfalseä½¿ç”¨çº¿ç¨‹æ± æœ€å¤§å¤§å°
     * @return æ·»åŠ æˆåŠŸå°±è¿”å›trueå¦åˆ™è¿”å›false
     */
   private boolean addWorker(Runnable firstTask, boolean core) {
        retry:
        for (;;) {
            //è¿™ä¸¤å¥ç”¨æ¥è·å–çº¿ç¨‹æ± çš„çŠ¶æ€
            int c = ctl.get();
            int rs = runStateOf(c);

            // Check if queue empty only if necessary.
            if (rs >= SHUTDOWN &&
                ! (rs == SHUTDOWN &&
                   firstTask == null &&
                   ! workQueue.isEmpty()))
                return false;

            for (;;) {
               //è·å–çº¿ç¨‹æ± ä¸­å·¥ä½œçš„çº¿ç¨‹çš„æ•°é‡
                int wc = workerCountOf(c);
                // coreå‚æ•°ä¸ºfalseçš„è¯è¡¨æ˜é˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œçº¿ç¨‹æ± å¤§å°å˜ä¸º maximumPoolSize
                if (wc >= CAPACITY ||
                    wc >= (core ? corePoolSize : maximumPoolSize))
                    return false;
               //åŸå­æ“ä½œå°†workcountçš„æ•°é‡åŠ 1
                if (compareAndIncrementWorkerCount(c))
                    break retry;
                // å¦‚æœçº¿ç¨‹çš„çŠ¶æ€æ”¹å˜äº†å°±å†æ¬¡æ‰§è¡Œä¸Šè¿°æ“ä½œ
                c = ctl.get();
                if (runStateOf(c) != rs)
                    continue retry;
                // else CAS failed due to workerCount change; retry inner loop
            }
        }
        // æ ‡è®°å·¥ä½œçº¿ç¨‹æ˜¯å¦å¯åŠ¨æˆåŠŸ
        boolean workerStarted = false;
        // æ ‡è®°å·¥ä½œçº¿ç¨‹æ˜¯å¦åˆ›å»ºæˆåŠŸ
        boolean workerAdded = false;
        Worker w = null;
        try {

            w = new Worker(firstTask);
            final Thread t = w.thread;
            if (t != null) {
              // åŠ é”
                final ReentrantLock mainLock = this.mainLock;
                mainLock.lock();
                try {
                   //è·å–çº¿ç¨‹æ± çŠ¶æ€
                    int rs = runStateOf(ctl.get());
                   //rs < SHUTDOWN å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¾ç„¶ä¸ºRUNNING,å¹¶ä¸”çº¿ç¨‹çš„çŠ¶æ€æ˜¯å­˜æ´»çš„è¯ï¼Œå°±ä¼šå°†å·¥ä½œçº¿ç¨‹æ·»åŠ åˆ°å·¥ä½œçº¿ç¨‹é›†åˆä¸­
                  //(rs=SHUTDOWN && firstTask == null)å¦‚æœçº¿ç¨‹æ± çŠ¶æ€å°äºSTOPï¼Œä¹Ÿå°±æ˜¯RUNNINGæˆ–è€…SHUTDOWNçŠ¶æ€ä¸‹ï¼ŒåŒæ—¶ä¼ å…¥çš„ä»»åŠ¡å®ä¾‹firstTaskä¸ºnullï¼Œåˆ™éœ€è¦æ·»åŠ åˆ°å·¥ä½œçº¿ç¨‹é›†åˆå’Œå¯åŠ¨æ–°çš„Worker
                   // firstTask == nullè¯æ˜åªæ–°å»ºçº¿ç¨‹è€Œä¸æ‰§è¡Œä»»åŠ¡
                    if (rs < SHUTDOWN ||
                        (rs == SHUTDOWN && firstTask == null)) {
                        if (t.isAlive()) // precheck that t is startable
                            throw new IllegalThreadStateException();
                        workers.add(w);
                       //æ›´æ–°å½“å‰å·¥ä½œçº¿ç¨‹çš„æœ€å¤§å®¹é‡
                        int s = workers.size();
                        if (s > largestPoolSize)
                            largestPoolSize = s;
                      // å·¥ä½œçº¿ç¨‹æ˜¯å¦å¯åŠ¨æˆåŠŸ
                        workerAdded = true;
                    }
                } finally {
                    // é‡Šæ”¾é”
                    mainLock.unlock();
                }
                //// å¦‚æœæˆåŠŸæ·»åŠ å·¥ä½œçº¿ç¨‹ï¼Œåˆ™è°ƒç”¨Workerå†…éƒ¨çš„çº¿ç¨‹å®ä¾‹tçš„Thread#start()æ–¹æ³•å¯åŠ¨çœŸå®çš„çº¿ç¨‹å®ä¾‹
                if (workerAdded) {
                    t.start();
                  /// æ ‡è®°çº¿ç¨‹å¯åŠ¨æˆåŠŸ
                    workerStarted = true;
                }
            }
        } finally {
           // çº¿ç¨‹å¯åŠ¨å¤±è´¥ï¼Œéœ€è¦ä»å·¥ä½œçº¿ç¨‹ä¸­ç§»é™¤å¯¹åº”çš„Worker
            if (! workerStarted)
                addWorkerFailed(w);
        }
        return workerStarted;
    }
```

æ›´å¤šå…³äºçº¿ç¨‹æ± æºç åˆ†æçš„å†…å®¹æ¨èè¿™ç¯‡æ–‡ç« ï¼šç¡¬æ ¸å¹²è´§ï¼š[4W å­—ä»æºç ä¸Šåˆ†æ JUC çº¿ç¨‹æ±  ThreadPoolExecutor çš„å®ç°åŸç†](https://www.throwx.cn/2020/08/23/java-concurrency-thread-pool-executor/)

ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨å›åˆ°ç¤ºä¾‹ä»£ç ï¼Œ ç°åœ¨åº”è¯¥æ˜¯ä¸æ˜¯å¾ˆå®¹æ˜“å°±å¯ä»¥ææ‡‚å®ƒçš„åŸç†äº†å‘¢ï¼Ÿ

æ²¡ææ‡‚çš„è¯ï¼Œä¹Ÿæ²¡å…³ç³»ï¼Œå¯ä»¥çœ‹çœ‹æˆ‘çš„åˆ†æï¼š

> æˆ‘ä»¬åœ¨ä»£ç ä¸­æ¨¡æ‹Ÿäº† 10 ä¸ªä»»åŠ¡ï¼Œæˆ‘ä»¬é…ç½®çš„æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º 5 ã€ç­‰å¾…é˜Ÿåˆ—å®¹é‡ä¸º 100 ï¼Œæ‰€ä»¥æ¯æ¬¡åªå¯èƒ½å­˜åœ¨ 5 ä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œå‰©ä¸‹çš„ 5 ä¸ªä»»åŠ¡ä¼šè¢«æ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­å»ã€‚å½“å‰çš„ 5 ä¸ªä»»åŠ¡ä¸­å¦‚æœæœ‰ä»»åŠ¡è¢«æ‰§è¡Œå®Œäº†ï¼Œçº¿ç¨‹æ± å°±ä¼šå»æ‹¿æ–°çš„ä»»åŠ¡æ‰§è¡Œã€‚



#### å¸¸è§å¯¹æ¯”

##### `Runnable` vs `Callable`

`Runnable`è‡ª Java 1.0 ä»¥æ¥ä¸€ç›´å­˜åœ¨ï¼Œä½†`Callable`ä»…åœ¨ Java 1.5 ä¸­å¼•å…¥,ç›®çš„å°±æ˜¯ä¸ºäº†æ¥å¤„ç†`Runnable`ä¸æ”¯æŒçš„ç”¨ä¾‹ã€‚**`Runnable` æ¥å£**ä¸ä¼šè¿”å›ç»“æœæˆ–æŠ›å‡ºæ£€æŸ¥å¼‚å¸¸ï¼Œä½†æ˜¯ **`Callable` æ¥å£**å¯ä»¥ã€‚æ‰€ä»¥ï¼Œå¦‚æœä»»åŠ¡ä¸éœ€è¦è¿”å›ç»“æœæˆ–æŠ›å‡ºå¼‚å¸¸æ¨èä½¿ç”¨ **`Runnable` æ¥å£**ï¼Œè¿™æ ·ä»£ç çœ‹èµ·æ¥ä¼šæ›´åŠ ç®€æ´ã€‚

å·¥å…·ç±» `Executors` å¯ä»¥å®ç°å°† `Runnable` å¯¹è±¡è½¬æ¢æˆ `Callable` å¯¹è±¡ã€‚ï¼ˆ`Executors.callable(Runnable task)` æˆ– `Executors.callable(Runnable task, Object result)`ï¼‰ã€‚

`Runnable.java`

```java
@FunctionalInterface
public interface Runnable {
   /**
    * è¢«çº¿ç¨‹æ‰§è¡Œï¼Œæ²¡æœ‰è¿”å›å€¼ä¹Ÿæ— æ³•æŠ›å‡ºå¼‚å¸¸
    */
    public abstract void run();
}
```

`Callable.java`

```java
@FunctionalInterface
public interface Callable<V> {
    /**
     * è®¡ç®—ç»“æœï¼Œæˆ–åœ¨æ— æ³•è¿™æ ·åšæ—¶æŠ›å‡ºå¼‚å¸¸ã€‚
     * @return è®¡ç®—å¾—å‡ºçš„ç»“æœ
     * @throws å¦‚æœæ— æ³•è®¡ç®—ç»“æœï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
     */
    V call() throws Exception;
}
```



##### `execute()` vs `submit()`

- `execute()`æ–¹æ³•ç”¨äºæäº¤ä¸éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ï¼Œæ‰€ä»¥æ— æ³•åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«çº¿ç¨‹æ± æ‰§è¡ŒæˆåŠŸä¸å¦ï¼›
- `submit()`æ–¹æ³•ç”¨äºæäº¤éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ã€‚çº¿ç¨‹æ± ä¼šè¿”å›ä¸€ä¸ª `Future` ç±»å‹çš„å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ª `Future` å¯¹è±¡å¯ä»¥åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ `Future` çš„ `get()`æ–¹æ³•æ¥è·å–è¿”å›å€¼ï¼Œ`get()`æ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°ä»»åŠ¡å®Œæˆï¼Œè€Œä½¿ç”¨ `get(long timeoutï¼ŒTimeUnit unit)`æ–¹æ³•çš„è¯ï¼Œå¦‚æœåœ¨ `timeout` æ—¶é—´å†…ä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼Œå°±ä¼šæŠ›å‡º `java.util.concurrent.TimeoutException`ã€‚

è¿™é‡Œåªæ˜¯ä¸ºäº†æ¼”ç¤ºä½¿ç”¨ï¼Œæ¨èä½¿ç”¨ `ThreadPoolExecutor` æ„é€ æ–¹æ³•æ¥åˆ›å»ºçº¿ç¨‹æ± ã€‚

ç¤ºä¾‹ 1ï¼šä½¿ç”¨ `get()`æ–¹æ³•è·å–è¿”å›å€¼ã€‚

```java
ExecutorService executorService = Executors.newFixedThreadPool(3);

Future<String> submit = executorService.submit(() -> {
    try {
        Thread.sleep(5000L);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    return "abc";
});

String s = submit.get();
System.out.println(s);
executorService.shutdown();
```

è¾“å‡ºï¼š

```text
abc
```

ç¤ºä¾‹ 2ï¼šä½¿ç”¨ `get(long timeoutï¼ŒTimeUnit unit)`æ–¹æ³•è·å–è¿”å›å€¼ã€‚

```java
ExecutorService executorService = Executors.newFixedThreadPool(3);

Future<String> submit = executorService.submit(() -> {
    try {
        Thread.sleep(5000L);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    return "abc";
});

String s = submit.get(3, TimeUnit.SECONDS);
System.out.println(s);
executorService.shutdown();
```

è¾“å‡ºï¼š

```text
Exception in thread "main" java.util.concurrent.TimeoutException
	at java.util.concurrent.FutureTask.get(FutureTask.java:205)
```



##### `shutdown()`VS`shutdownNow()`

- **`shutdownï¼ˆï¼‰`** :å…³é—­çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± çš„çŠ¶æ€å˜ä¸º `SHUTDOWN`ã€‚çº¿ç¨‹æ± ä¸å†æ¥å—æ–°ä»»åŠ¡äº†ï¼Œä½†æ˜¯é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡å¾—æ‰§è¡Œå®Œæ¯•ã€‚
- **`shutdownNowï¼ˆï¼‰`** :å…³é—­çº¿ç¨‹æ± ï¼Œçº¿ç¨‹çš„çŠ¶æ€å˜ä¸º `STOP`ã€‚çº¿ç¨‹æ± ä¼šç»ˆæ­¢å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œå¹¶åœæ­¢å¤„ç†æ’é˜Ÿçš„ä»»åŠ¡å¹¶è¿”å›æ­£åœ¨ç­‰å¾…æ‰§è¡Œçš„ Listã€‚



##### `isTerminated()` VS `isShutdown()`

- **`isShutDown`** å½“è°ƒç”¨ `shutdown()` æ–¹æ³•åè¿”å›ä¸º trueã€‚
- **`isTerminated`** å½“è°ƒç”¨ `shutdown()` æ–¹æ³•åï¼Œå¹¶ä¸”æ‰€æœ‰æäº¤çš„ä»»åŠ¡å®Œæˆåè¿”å›ä¸º true
